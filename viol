# ELABORAÇÃO: CARINA HEUSNER GONÇALVES DE SOUSA - CRBM: 48450 
# DATA DA ELABORAÇÃO: 11/10/2023
# LOCAL DA ELBORAÇÃO: ESTÁGIO OPTATIVO CAP 2.2, PARTE DA RESIDÊNCIA EM SAÚDE COLETIVA (IESC/UFRJ) 

##########################################
# ANÁLISE DE BANCO DE SINAN DA VIOLÊNCIA #
##########################################

#BANCO EXTRAÍDO EM: 10/10/2023 
#PERÍODO DA EXTRAÇÃO: JANEIRO A SETEMBRO DE 2023 


# Passo 1: Escolher diretório: Selecionar o diretório de trabalho (working directory):
# Manualmente: Session > Set Working Directory >  Choose Directory
# Esse passo é para escolher a PASTA em que se encontra o arquivo no pc, no entanto, não vai aparecer o arquivo do banco quando fizer isso!!

# Passo 2: Instalar pacotes e chamar as bibliotecas:
# Instalar: Na aba a direita inferior, va em Packages >> Install >> escreve nome do pacote e clicar em install


library(rio)  # permite importar bases de dados
library (readxl)# permite ler excel
library(tidyr) # permite trocar o NA por alguma categoria
library(ggplot2) # graficos
library(gtsummary) # tabelas
library(gt) # tabelas
library(janitor) # limpa bases de dados
library (tidyverse)# transorma e apresenta melhor os dados
library (lubridate)


# Passo 3: Carregar banco de dados
dados <- import(choose.files())

# Passo 4: Excluir colunas que não são de interesse de análise
# Tem dois possíveis comandos:

#dados <- subset(dados, select =c(UNIDADE_SEG, DT_NOTIFIC, DT_NASC, CS_SEXO, CS_GESTANT, CS_RACA, CS_ESCOL_N, SIT_CONJUG, 
                                  DEF_TRANSF, DEF_FISICA, DEF_MENTAL, DEF_VISUAL, DEF_AUDITI, TRAN_MENTAL, TRAN_COMP, DEF_OUT, 
                                  DEF_ESPEC, LOCAL_OCOR, OUT_VEZES, LES_AUTOP, VIOL_FISIC, VIOL_PSICO, VIOL_TRAF, VIOL_FINAN, 
                                  VIOL_NEGLI, VIOL_INFAN, VIOL_LEGAL, VIOL_OUTR, VIOL_ESPEC, AG_FORCA, AG_ENFOR, AG_AG_OBJETO, 
                                  AG_CORTE, AG_QUENTE, AG_ENVEN, AG_FOGO, AG_AMEACA, AG_OUTROS, SEX_ASSEDI, SEX_ESTUPR, SEX_PUDOR, 
                                  SEX_PORNO, SEXO_EXPLO, SEXO_OUTRO, REL_PAI, REL_MAE, REL_PAD, REL_MAD, REL_CONJ, REL_EXCON, REL_NAMO, 
                                  REL_EXNAM, REL_FILHO, REL_IRMÃO, REL_CONHEC, REL_CUIDA, REL_PATRAO,	REL_INST,	REL_POL,	REL_PROPRI,	
                                  REL_OUTROS, REL_ESPEC, AUTOR_SEXO, AUTOR_ALCO, CICLO_VID, CIRC_LESAO)) %>% filter(ANALITIC == "1")

# Passo 5: Verificar a classicação de cada variavel
sapply(dados, FUN="typeof")

# Passo 6: Reclassificar as variáveis
dados <- dados %>%  mutate(DT_NOTIFIC = as.Date(DATNOTIF, format = "%Y-%m-%d"),
                           NU_IDADE_N = as.number(NU_IDADE_N),
                           CS_SEXO = as.factor(CS_SEXO),
                           CS_RACACOR = as.factor(CS_RACACOR),
                           CS_ESCOL_N = as.factor(CS_ESCOL_N),
                           OUT_VEZES = as.factor(OUT_VEZES),
                           LES_AUTOP = as.facotr(LES_AUTOP),
                           VIOL_FISIC = as.factor(VIOL_FISIC),
                           VIOL_PSICO = as.factor(VIOL_PSICO),
                           VIOL_TORT = as.factor(VIOL_TORT),
                           VIOL_SEXU = as.factor(VIOL_SEXU),
                           VIOL_TRAF	= as.factor
                           VIOL_FINAN	= as.factor
                           VIOL_NEGLI	= as.factor
                           VIOL_INFAN	= as.factor
                           VIOL_LEGAL	= as.factor
                           VIOL_OUTR = as.factor
                           VIOL_ESPEC = as.factor
                           AG_FORCA	= as.factor
                           AG_ENFOR	= as.factor
                           AG_OBJETO = as.factor
                           AG_CORTE	= as.factor
                           AG_QUENTE = as.factor
                           AG_ENVEN = as.factor
                           AG_FOGO = as.factor
                           AG_AMEACA = as.factor
                           AG_OUTROS = as.factor
                           AG_ESPEC = as.factor
                           CIRC_LESAO

                           
                           

# Passo 7: Recodificar as variáveis
# Olhar como estão as respostas de cada variável para poder recodificar
glimpse(dados)

dados <- dados %>%  mutate(CS_SEXO = recode(SEXO,
                                         "M" = "Masculino",
                                         "F" = "Feminino"),
                          (CS_GESTANT = recode(CS_GESTANT,
                                              "1" = "1º Trimestre"
                                              "2" = "2º Trimestre"
                                              "3" = "3º Trimestre"
                                              "4" = "Idade gestacional ignorada"
                                              "5" = "Não"
                                              "6" = "Não se aplica"
                                              "9" = "Ignorado"),
                           CS_RACA = recode (CS_RACA,
                                             "1" = "BRANCA",
                                             "2" = "PRETA",
                                             "3" = "AMARELA",
                                             "4" = "PARDA",
                                             "5" = "INDÍGENA",
                                             "9" = "IGNORADO"),
                           CS_ESCOL_N = recode (CS_ESCOL_N,
                                              "0" = "ANALFABETO",
                                              "1" = "ENSINO FUNDAMENTAL INCOMPLETO",
                                              "2" = "ENSINO FUNDAMENTAL INCOMPLETO",
                                              "3" = "ENSINO FUNDAMENTAL INCOMPLETO",
                                              "4" = "ENSINO FUNDAMENTAL COMPLETO",
                                              "5" = "ENSINO MEDIO INCOMPLETO",
                                              "6" = "ENSINO MEDIO COMPLETO",
                                              "7" = "ENSINO SUPERIOR INCOMPLETO",
                                              "8" = "ENSINO SUPERIOR COMPLETO",
                                              "9" = "IGNORADO",
                                              "10" = "NAO SE APLICA"),
                          SIT_CONJUG = recorde(SIT_CONJUG, 
                                                "1" = "SOLTEIRO",
                                                "2" = "CASADO/UNIÃO CONSENSUAL",
                                                "3" = "VIÚVO",
                                                "4" = "SEPARADO",
                                                "8" = "NÃO SE APLICA"),
                           DEF_TRANS = recorde(DEF_TRNS,
                                                "1" = "SIM",
                                                "2" = "NÃO",

                                                "9" = "IGNORADO"),
                            DEF_FISICA = recorde(DEF_FISICA,
                                                "1" = "SIM",
                                                "2" = "NÃO",
                                                "9" = "IGNORADO"),
                            DEF_MENTAL = recorde(DEF_MENTAL,
                                                "1" = "SIM",
                                                "2" = "NÃO",
                                                "9" = "IGNORADO"),
                            DEF_VISUAL = recorde(DEF_VISUAL,
                                                "1" = "SIM",
                                                "2" = "NÃO",
                                                "9" = "IGNORADO"),
                            DEF_AUDITI = recorde(DEF_AUDITI,
                                                "1" = "SIM",
                                                "2" = "NÃO",
                                                "9" = "IGNORADO"),
                            TRAN_MENTAL = recorde(TRAN_MENTAL,
                                                "1" = "SIM",
                                                "2" = "NÃO",
                                                "9" = "IGNORADO"),
                            TRAN_COMP = recorde(TRAN_COMP,
                                                "1" = "SIM",
                                                "2" = "NÃO",
                                                "9" = "IGNORADO"),
                            LOCAL_OCOR = recorde(LOCAL_OCOR,
                                                "01" = "RESIDÊNCIA",
                                                "02" = "HABITAÇÃO COLETIVA",
                                                "03" = "ESCOLA",
                                                "04" = "LOCAL DE PRÁTICA ESPORTIVA",
                                                "05" = BAR OU SIMILAR
                                                "06" = VIA PUBLICA,
                                                "07" = "COMÉRCIO/SERVIÇO",
                                                "08" = "INDUSTRIAS/CONSTRUÇÃO",
                                                "09" = "OUTRO",
                                                "99" = "IGNORADO"),

                           CIRC_LESAO = recorde (CIRC_LESAO, 
                                                  
# Passo 8: Criar idade e faixa etária
dados <- dados %>% mutate(IDADE = DT_NOTIFIC - DT_NASC)
                           
class(dados$IDADE)
dados <- dados %>% mutate(IDADE = as.numeric(IDADE))                        
                    
dados <- dados %>% mutate(IDADE.anos = IDADE/365.25 )

summary(dados$IDADE.anos)
boxplot(dados$IDADE.anos)

dados <- dados %>% mutate("FX_ETARIA" = cut(IDADE.anos,
                                             breaks = c(12,20,40, 60, Inf),
                                             right = FALSE,
                                             labels = c("12 a 19", "20 a 39", "40 a 59", 
                                                        "60 ou mais")))

